<!doctype html> 
<html lang="en"> 
<head>  
    <meta charset="UTF-8" />
    <title>The Virus Among Us</title>
    <script src="//cdn.jsdelivr.net/npm/phaser@3.22.0/dist/phaser.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<script type="text/javascript">

var BootScene = new Phaser.Class({
 
    Extends: Phaser.Scene,
 
    initialize:
 
    function BootScene ()
    {
        Phaser.Scene.call(this, { key: 'BootScene' });
    },
	//assets werden in die Boot-Szene geladen
    preload: function ()
    {
       this.load.tilemapTiledJSON('map','assets/tilemap.json');
	   this.load.image('mainlevbuild','assets/mainlevbuild.png');
	   this.load.image('teiletiles','assets/teiletiles.png');
	   this.load.image('wallstileset','assets/wallstileset.png');
	   this.load.image('objecttiles','assets/objecttiles.png');
	   this.load.spritesheet('bluespritesheet','assets/bluespritesheet.png',{ frameWidth: 32, frameHeight: 32 });
	   
	   	   
	   this.load.image('dragonblue', 'assets/dragonblue.png');
	   this.load.image('dragonred', 'assets/dragonred.png');
	   this.load.image('lobby','assets/lobby');
    },
	
    create: function ()
    {
        this.scene.start('LobbyScene');
    }
});

var LobbyScene = new Phaser.Class({
 
    Extends: Phaser.Scene,
 
    initialize:
 
    function LobbyScene ()
    {
        Phaser.Scene.call(this, { key: 'LobbyScene' });
    },
    create: function ()
    {
        // Run UI Scene at the same time
         this.scene.launch('LobbyUIScene');
		 this.add.image(100, 100,'lobby');
		 
		 this.background = this.add.tileSprite(100,100,0,0,'lobby');
		 
		 player = this.player = this.physics.add.sprite(50, 100, 'bluespritesheet');
		 this.player.setCollideWorldBounds(true);
		 this.player.setBounce(1);
		
		
		
		var map = this.make.tilemap({ key: 'map' });
		this.physics.world.bounds.width = map.widthInPixels -= 470;
        this.physics.world.bounds.height = map.heightInPixels -= 450;
        this.player.setCollideWorldBounds(true);	
		
		//Erzeugen der Inputs	
		this.cursors = this.input.keyboard.createCursorKeys();
		
    },
	
	update: function (time,delta)
	{
	
	if (this.cursors.left.isDown)
        {
            this.player.body.setVelocityX(-40);
			//this.player.anims.play('walk', true);
        }
        else if (this.cursors.right.isDown)
        {
            this.player.body.setVelocityX(40);
			//this.player.anims.play('walk', true);
        }
 
        // Vertical movement
        if (this.cursors.up.isDown)
        {
            this.player.body.setVelocityY(-40);
			//this.player.anims.play('walk', true);
        }
        else if (this.cursors.down.isDown)
        {
            this.player.body.setVelocityY(40);
			//this.player.anims.play('walk', true);
        }  
		
	this.timer += delta;
    while (this.timer > 1000) {
        this.resources += 1;
        this.timer -= 1000;
    }
		this.background.tilePositionY += 5;

	},
});

var LobbyUIScene = new Phaser.Class({
 
    Extends: Phaser.Scene,
 
    initialize:
 
    function LobbyUIScene ()
    {
        Phaser.Scene.call(this, { key: 'LobbyUIScene' });
    },
 
    create: function ()
    {    
        this.graphics = this.add.graphics();
        this.graphics.lineStyle(1, 0xffffff);
        this.graphics.fillStyle(0x031f4c, 1);        
        this.graphics.strokeRect(2, 185, 318, 100);
        this.graphics.fillRect(2, 185, 318, 100);
        
		 var text = this.add.text(75,200, 'Start the Game!');
		text.setInteractive({ useHandCursor: true });
		text.on('pointerdown', () => this.scene.start('WorldScene'));	
		
		
    }

	
});


 
var WorldScene = new Phaser.Class({
 
    Extends: Phaser.Scene,
 
    initialize:
 
    function WorldScene ()
    {
        Phaser.Scene.call(this, { key: 'WorldScene' });
		
    },
	//In die World-Szene werden keine assets geladen. Die sind schon in der Boot-Szene geladen worden
    preload: function ()
    {
       
    },
	
	//Elemente die im Spiel erzeugt werden.
    create: function ()
    {
		this.scene.stop('LobbyScene');
		//Karte wird erstellt
        var map = this.make.tilemap({ key: 'map' });
		
		//Texturvariable = Bild im Asset-Ordner (Tileset in der JSON-Map, dazugehöriges Bild im Assets-Ordner )
		var groundtiles = map.addTilesetImage('groundtiles', 'mainlevbuild');
		var obstacletiles = map.addTilesetImage('obstacleteils','teiletiles');
		var wallstileset = map.addTilesetImage('wallstileset','wallstileset');
		var objecttiles = map.addTilesetImage('objecttileset','objecttiles');
		
		//Layervariable = erzeuge Statische Schicht (oder Objekt) (Name des Layers, Tileset in der JSON-Map, Position)
		var ground = map.createStaticLayer('ground', groundtiles, 0, 0);
		var obstacles = map.createStaticLayer('obstacles', obstacletiles, 0,0);
		var walls = map.createStaticLayer('walls', wallstileset, 0,0);
		var objects = map.createStaticLayer('objectlayer',objecttiles,0,0);
		//Collision der Layers
		walls.setCollisionByExclusion([-1]);
		objects.setCollisionByExclusion([-1]);
		
		//Erzeugen des Spielers		
		player = this.player = this.physics.add.sprite(50, 100, 'bluespritesheet');
		//Erzeugen der Kartengröße und Ränder
		this.physics.world.bounds.width = map.widthInPixels;
        this.physics.world.bounds.height = map.heightInPixels;
        this.player.setCollideWorldBounds(true);
		
		//Erzeugen der Inputs	
		this.cursors = this.input.keyboard.createCursorKeys();
		
		//Erzeugen der Kamera
		this.cameras.main.setBounds(0, 0, map.widthInPixels, map.heightInPixels);
        this.cameras.main.startFollow(this.player);
        this.cameras.main.roundPixels = true;
		
		//Erzeugen der Animation (die nicht funktioniert)
		 this.anims.create({
            key: 'walk',
            frames: this.anims.generateFrameNumbers('player', { start: 0, end: 3 }),
            frameRate: 3,
            repeat: -1
        });
        
		//Kollision zwischen Spieler und Wänden (Objekte aktuell deaktiviert)
		this.physics.add.collider(this.player, walls);
		//this.physics.add.collider(this.player, objects);
		
		//Erzeugen der Zonen über den Computern
		 this.spawns = this.physics.add.group({ classType: Phaser.GameObjects.Zone });
        for(var i = 0; i < 5; i++) {
             
            this.spawns.create(400, 80, 20, 20); 
			this.spawns.create(240, 240, 20, 20);	
			this.spawns.create(80, 80, 20, 20);
			this.spawns.create(432, 302, 20, 20);
			this.spawns.create(432, 465, 20, 20);
			this.spawns.create(240, 430, 20, 20);
        }        
		//Trigger beim Berühren der Zonen
        this.physics.add.overlap(this.player, this.spawns, this.onMeetTask, false, this);
		
		
		
    },
	
	//fortlaufende Aktualisierungen
	update: function (time, delta)
	{
		this.player.body.setVelocity(0);
 
        // Horizontal movement
        if (this.cursors.left.isDown)
        {
            this.player.body.setVelocityX(-80);
			//this.player.anims.play('walk', true);
        }
        else if (this.cursors.right.isDown)
        {
            this.player.body.setVelocityX(80);
			//this.player.anims.play('walk', true);
        }
 
        // Vertical movement
        if (this.cursors.up.isDown)
        {
            this.player.body.setVelocityY(-80);
			//this.player.anims.play('walk', true);
        }
        else if (this.cursors.down.isDown)
        {
            this.player.body.setVelocityY(80);
			//this.player.anims.play('walk', true);
        }    
		
		 
		
	},
	
	onMeetTask: function (player, zone) 
		{
		if (this.cursors.space.isDown)
        {
		this.cameras.main.fade(500);
		//this.scene.sleep('WorldScene');
		this.scene.start('BattleScene');
		}
		},
	
});


var BattleScene = new Phaser.Class({
 
    Extends: Phaser.Scene,
 
    initialize:
 
    function BattleScene ()
	{
        Phaser.Scene.call(this, { key: 'BattleScene' });
    },
	
	preload: function ()
	{
  
	},
    create: function ()
    {
        this.cameras.main.setBackgroundColor('rgba(0, 200, 0, 0.5)');
		var dragonblue = this.player = this.physics.add.sprite(50, 100, 'dragonblue').setInteractive();
		this.input.setDraggable(dragonblue);
		var dragonred = this.physics.add.sprite(200, 200, 'dragonred').setInteractive();
		this.input.setDraggable(dragonred);

    
		this.input.dragDistanceThreshold = 16;

		this.input.on('dragstart', function (pointer, gameObject) {


		});

		this.input.on('drag', function (pointer, gameObject, dragX, dragY) {

        gameObject.x = dragX;
        gameObject.y = dragY;

		});

		this.physics.add.overlap(dragonblue, dragonred,this.endTask,false,this);

		this.input.on('dragend', function (pointer, gameObject) {

        gameObject.clearTint();

		});	
		
	
	
    },
	
	endTask: function(player, zone)
	{
	  this.cameras.main.fade(500);
	  this.scene.start('WorldScene');
	},
	

});
	
	

	//Gesamteinstellungen (kein Plan warum am Ende{Hab ich wohl verkackt})
    var config = {
    type: Phaser.WEBGL,
	parent: 'content',
    width: 320,
    height: 240,
	zoom: 2,
	pixelArt: true,
	physics: {
        default: 'arcade',
        arcade: {
            gravity: { y: 0 },
            debug: true
        }
	},
    scene: [
		BootScene,
		LobbyScene,
		LobbyUIScene,
        WorldScene,
		BattleScene
		]
    };
	
var game = new Phaser.Game(config);

	
</script>

</body>
</html>